<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feedback (iframe + extended client info)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; background:#fafafa; color:#222; }
    form { max-width:560px; margin:0 auto; display:flex; flex-direction:column; gap:10px; }
    input, textarea, button { padding:10px; font-size:14px; border:1px solid #ccc; border-radius:6px; background:#fff; }
    button { cursor:pointer; background:#0b79d0; color:#fff; border:0; padding:11px; font-weight:600; }
    button[disabled] { opacity:.7; cursor:not-allowed; }

    /* message */
    #msg { max-width:560px; margin:12px auto; font-size:15px; display:none; text-align:center; }

    /* overlay + spinner */
    .overlay {
      display:none;
      position:fixed; inset:0;
      background: rgba(255,255,255,0.78);
      z-index:9999;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:12px;
    }
    .spinner {
      width:56px; height:56px;
      border:8px solid rgba(0,0,0,0.12);
      border-top-color: rgba(0,0,0,0.6);
      border-radius:50%;
      animation:spin 0.9s linear infinite;
      box-shadow:0 4px 12px rgba(0,0,0,0.06);
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .overlay .text { font-size:15px; color:#333; }

    /* hide iframe visually but keep it in DOM */
    iframe[name="hidden_iframe"] { width:0; height:0; border:0; position:absolute; left:-9999px; top:-9999px; }
  </style>
</head>
<body>

  <!-- Replace ACTION with your Apps Script exec URL -->
  <form id="feedbackForm" action="https://script.google.com/macros/s/AKfycbzR1UUxUiezO6N-UyMd4seAvOXMekj7_GaclQM5gdqoFNv8tQ2vWBJvYuKm9Uh69W4f/exec" method="POST" target="hidden_iframe" novalidate>
    <input name="name" placeholder="Name" required />
    <input name="email" type="email" placeholder="Email" required />
    <textarea name="message" placeholder="Your feedback" required rows="6"></textarea>

    <!-- hidden fields for extended client info -->
    <input type="hidden" name="userAgent" id="hf_userAgent">
    <input type="hidden" name="platform" id="hf_platform">
    <input type="hidden" name="language" id="hf_language">
    <input type="hidden" name="languages" id="hf_languages">
    <input type="hidden" name="timezone" id="hf_timezone">
    <input type="hidden" name="timezoneOffset" id="hf_timezoneOffset">
    <input type="hidden" name="screenWidth" id="hf_screenWidth">
    <input type="hidden" name="screenHeight" id="hf_screenHeight">
    <input type="hidden" name="devicePixelRatio" id="hf_dpr">
    <input type="hidden" name="touchSupport" id="hf_touchSupport">
    <input type="hidden" name="maxTouchPoints" id="hf_maxTouchPoints">
    <input type="hidden" name="connectionType" id="hf_connectionType">
    <input type="hidden" name="connectionDownlink" id="hf_connectionDownlink">
    <input type="hidden" name="connectionRtt" id="hf_connectionRtt">
    <input type="hidden" name="online" id="hf_online">
    <input type="hidden" name="pageURL" id="hf_pageURL">
    <input type="hidden" name="referrer" id="hf_referrer">
    <input type="hidden" name="localTimestamp" id="hf_localTimestamp">
    <input type="hidden" name="timeOnPageMs" id="hf_timeOnPageMs">
    <input type="hidden" name="batteryPercent" id="hf_batteryPercent">
    <input type="hidden" name="batteryCharging" id="hf_batteryCharging">

    <button id="submitBtn" type="submit">Submit</button>
  </form>

  <iframe name="hidden_iframe" aria-hidden="true"></iframe>

  <div id="msg" role="status" aria-live="polite"></div>

  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="spinner" aria-hidden="true"></div>
    <div class="text">Sending feedbackâ€¦</div>
  </div>

<script>
(function(){
  const SUBMIT_TIMEOUT_MS = 20000; // 20s
  const form = document.getElementById('feedbackForm');
  const submitBtn = document.getElementById('submitBtn');
  const overlay = document.getElementById('overlay');
  const msg = document.getElementById('msg');
  const iframe = document.querySelector('iframe[name="hidden_iframe"]');

  let pageLoadTime = Date.now();
  let submitted = false;
  let timeoutId = null;
  let initialIframeLoadIgnored = false;

  // Populate synchronous fields
  function fillSyncFields() {
    try {
      document.getElementById('hf_userAgent').value = navigator.userAgent || '';
      document.getElementById('hf_platform').value = navigator.platform || '';
      document.getElementById('hf_language').value = navigator.language || '';
      document.getElementById('hf_languages').value = (navigator.languages && navigator.languages.join(',')) || '';
      document.getElementById('hf_timezone').value = (Intl && Intl.DateTimeFormat && Intl.DateTimeFormat().resolvedOptions ? Intl.DateTimeFormat().resolvedOptions().timeZone : '');
      document.getElementById('hf_timezoneOffset').value = String(new Date().getTimezoneOffset());
      document.getElementById('hf_screenWidth').value = (screen && screen.width) ? String(screen.width) : '';
      document.getElementById('hf_screenHeight').value = (screen && screen.height) ? String(screen.height) : '';
      document.getElementById('hf_dpr').value = (window.devicePixelRatio) ? String(window.devicePixelRatio) : '';
      document.getElementById('hf_touchSupport').value = (('ontouchstart' in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 0)) ? 'true' : 'false';
      document.getElementById('hf_maxTouchPoints').value = (navigator.maxTouchPoints !== undefined) ? String(navigator.maxTouchPoints) : '';
      document.getElementById('hf_online').value = navigator.onLine ? 'true' : 'false';
      document.getElementById('hf_pageURL').value = window.location.href || '';
      document.getElementById('hf_referrer').value = document.referrer || '';
      document.getElementById('hf_localTimestamp').value = new Date().toISOString();
      document.getElementById('hf_timeOnPageMs').value = String(Date.now() - pageLoadTime);
    } catch (e) {
      // ignore
    }
  }

  // Populate connection info if available
  function fillConnectionFields() {
    try {
      const conn = (navigator.connection || navigator.mozConnection || navigator.webkitConnection);
      if (conn) {
        document.getElementById('hf_connectionType').value = conn.effectiveType || (conn.type || '');
        document.getElementById('hf_connectionDownlink').value = (conn.downlink !== undefined) ? String(conn.downlink) : '';
        document.getElementById('hf_connectionRtt').value = (conn.rtt !== undefined) ? String(conn.rtt) : '';
      } else {
        document.getElementById('hf_connectionType').value = '';
        document.getElementById('hf_connectionDownlink').value = '';
        document.getElementById('hf_connectionRtt').value = '';
      }
    } catch (e) {
      // ignore
    }
  }

  // Populate battery info if available (async)
  async function fillBatteryFields() {
    try {
      if ('getBattery' in navigator) {
        const b = await navigator.getBattery();
        document.getElementById('hf_batteryPercent').value = (typeof b.level === 'number') ? String(Math.round(b.level * 100)) : '';
        document.getElementById('hf_batteryCharging').value = (typeof b.charging === 'boolean') ? String(b.charging) : '';
      } else {
        document.getElementById('hf_batteryPercent').value = '';
        document.getElementById('hf_batteryCharging').value = '';
      }
    } catch (e) {
      document.getElementById('hf_batteryPercent').value = '';
      document.getElementById('hf_batteryCharging').value = '';
    }
  }

  // UI helpers
  function showOverlay() { overlay.style.display = 'flex'; overlay.setAttribute('aria-hidden','false'); }
  function hideOverlay() { overlay.style.display = 'none'; overlay.setAttribute('aria-hidden','true'); }
  function showMsg(text, isError) {
    msg.textContent = text;
    msg.style.color = isError ? 'crimson' : 'green';
    msg.style.display = 'block';
  }
  function hideMsg() { msg.style.display = 'none'; }

  iframe.addEventListener('load', function() {
    if (!initialIframeLoadIgnored) { initialIframeLoadIgnored = true; return; }
    if (submitted) completeSubmission();
  });

  function startSubmission() {
    submitted = true;
    hideMsg();
    submitBtn.disabled = true;
    showOverlay();
    timeoutId = setTimeout(function(){
      timeoutId = null;
      submitted = false;
      hideOverlay();
      submitBtn.disabled = false;
      showMsg('Submission may have failed (timeout). Please try again.', true);
    }, SUBMIT_TIMEOUT_MS);
  }

  function completeSubmission() {
    if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; }
    submitted = false;
    hideOverlay();
    submitBtn.disabled = false;
    showMsg('Feedback submitted');
    try { form.reset(); } catch(e){}
  }

  // Ensure fields are populated before sending; use async to await battery
  async function prepareAndSubmit() {
    fillSyncFields();
    fillConnectionFields();
    await fillBatteryFields(); // wait for battery check (fast or empty)
    // update timeOnPage just before submit
    document.getElementById('hf_timeOnPageMs').value = String(Date.now() - pageLoadTime);
    startSubmission();
    // submit form to iframe
    try {
      form.submit(); // allows normal POST to iframe
    } catch(e) {
      // older browsers might throw; fallback: create a temporary form post
      const f = document.createElement('form');
      f.action = form.action;
      f.method = 'POST';
      f.target = form.target;
      // clone inputs
      Array.from(form.elements).forEach(el => {
        if (!el.name) return;
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = el.name;
        inp.value = el.value;
        f.appendChild(inp);
      });
      document.body.appendChild(f);
      f.submit();
      document.body.removeChild(f);
    }
  }

  // Submit handler: prevent default, fill fields, then submit programmatically
  form.addEventListener('submit', function(ev) {
    ev.preventDefault();
    // prepare and submit asynchronously; do not block UI
    prepareAndSubmit().catch(function(err){
      // if prepare fails, revert UI and show error
      if (timeoutId) { clearTimeout(timeoutId); timeoutId = null; }
      submitted = false;
      hideOverlay();
      submitBtn.disabled = false;
      showMsg('Error preparing submission. Please try again.', true);
    });
  });

  // initial fill
  fillSyncFields();
  fillConnectionFields();
  // warm battery fill in background (non-blocking)
  fillBatteryFields();

  window.addEventListener('beforeunload', function() {
    if (timeoutId) clearTimeout(timeoutId);
  });

})();
</script>

</body>
</html>
